# 标题
[[12/20][云服务][功能严重异常]preview窗口同时有视频与相机画面时，2者都掉帧严重。--如视频。](http://intellyva-win/zentao/bug-view-2619.html)
# 问题日志

# 问题类型

# 产生原因
40 张宽高比为 720x1280 的 preview 画面，平均每张画面大小为 255150B = 249KB。

可以节省：
1. rendercore ComposeRenderer 目前返回 Bitmap，改为直接返回字节流
2. LiveServer Bitmap 转 bytes
3. LiveClient bytes 转 Bitmap
4. DirectorApi Bitmap 转 bytes

2024-01-04 与 donny 讨论结果：
windowImage 改为回调的方式，指定帧率读取，为其单独开辟一块 buffer，不阻塞主线程，提高渲染效率。同时，为了减少转换过程，传输将直接返回字节流，但是需要研究有没有把原始数据直接压缩成 jpg 或 png 字节流的方法。

2024-01-11
已经改为直接接收字节流。
[提高 Camera 画面清晰度](http://intellyva:81/c/intellyva/services/cloudservice/+/23450)
[Preview 改为回调函数接收](http://intellyva:81/c/intellyva/services/cloudservice/+/23446)

2024-01-12 SingleCamera 的 period 给了 1000，应该给 66
```
2024-01-12 22:02:24.784  2398-2398  MessageProcessor        com.intellyva.cloudservice           D  onNotify() called with: connectId = [LINK_PERSISTENT], topic = [/ext/rrpc/1745808450283187200/j1d4LctzStO/WW32023001JRXADS01AA000000/user/director/operaCameraLens], aMessage = [{"id":"1745808450179960832","topic":"director/operaCameraLens","token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpZCI6ODEsImtleSI6ImJmNGY0OTJhLWUwM2MtNDA3MS1iMjU5LTJhNTlkZjczYWFjNSIsInVzZXJuYW1lIjoicXo2ZTdwIn0.VkLxFhm47QJQW6pAyWcPy2NnRZF4fJYQiYTnVYZvjVk","deviceName":"WW32023001JRXADS01AA000000","data":{"operaType":0,"bucketName":"cpl-thumbnail","period":1000,"previewType":0,"sourceList":[3],"maxDuration":60000},"isFromServer":true,"fromDeviceName":"cpl-server-prod"}]
```

## getWindowImage 耗时情况
```
2024-01-11 10:35:02.213  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:02.363  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:02.364  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:02.473  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:02.630  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:02.630  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:02.743  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:02.900  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:02.901  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:03.032  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:03.181  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:03.181  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:03.312  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:03.477  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:07.035  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:07.178  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:07.364  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:07.364  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:07.470  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:07.608  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:07.608  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:07.756  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:07.901  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:07.901  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:08.035  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:08.201  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:08.201  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:08.306  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:08.438  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:08.438  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:08.540  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:08.668  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:08.668  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:08.792  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:08.919  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:08.920  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:09.046  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:09.198  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:09.198  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:09.335  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:09.504  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:09.504  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:09.646  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:09.789  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:09.789  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:09.897  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:10.065  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:10.065  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:10.157  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:10.320  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:10.320  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:10.434  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:10.567  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:10.568  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:10.683  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:10.838  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:10.838  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:10.977  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:11.130  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:11.130  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:11.246  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:11.396  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:11.396  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:11.530  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:11.696  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:11.696  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:11.821  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:11.968  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:11.968  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:12.096  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:12.242  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:12.242  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:12.377  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:12.529  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:12.530  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:12.637  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:12.791  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:12.791  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:12.906  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:13.054  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:13.054  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:13.173  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:13.302  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:13.302  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:13.437  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:13.589  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:13.589  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:13.712  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:13.868  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:13.868  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:13.956  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:14.094  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:14.097  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:14.238  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:14.418  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:14.418  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:14.539  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:14.664  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:14.665  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:14.769  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:14.935  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:14.936  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:15.071  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:15.237  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:15.238  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:15.373  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:15.531  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:15.531  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:15.658  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:15.824  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:15.824  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:15.951  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:16.123  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:16.124  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:16.237  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:16.401  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:16.401  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:16.529  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:16.674  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:16.675  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:16.810  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:17.002  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:17.002  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:17.104  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:17.264  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:17.264  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:17.388  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:17.564  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:17.564  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:17.681  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:17.834  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:17.834  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:17.987  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:18.163  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:18.163  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:18.295  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:18.479  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:18.479  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:18.624  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:18.767  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:18.767  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:18.869  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:19.032  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:19.033  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:19.140  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:19.326  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:19.326  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:19.468  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:19.671  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:19.672  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:19.775  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:19.929  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:19.929  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:20.043  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:20.217  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:20.218  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:20.354  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:20.521  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:20.521  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:20.654  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:20.830  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:20.830  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:20.930  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:21.105  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:21.105  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:21.201  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:21.334  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:21.334  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:21.439  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:21.577  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:21.577  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:21.734  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:21.927  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:21.927  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:22.063  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:22.220  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:22.220  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:22.344  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:22.503  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:22.503  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:22.608  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:22.734  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:22.735  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:22.871  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:23.034  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:23.034  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:23.164  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:23.339  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:23.339  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:23.437  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:23.580  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:23.580  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:23.726  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:23.866  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:23.866  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:23.985  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:24.152  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:24.152  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:24.257  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:24.432  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:24.432  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:24.524  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:24.649  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:24.652  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:24.781  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:24.910  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:24.911  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:25.059  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:25.217  2400-4530  DirectorApi   D  upload image end
2024-01-11 10:35:25.218  2400-4530  DirectorApi   D  get image start
2024-01-11 10:35:25.326  2400-4530  DirectorApi   D  upload image start
2024-01-11 10:35:25.488  2400-4530  DirectorApi   D  upload image end
```

# 解决方案

## CommitId
|branch|commit|
|---|---|
|master|[]()|
|release|[]()|
# 影响范围

# 问题总结